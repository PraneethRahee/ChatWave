const Room = require('../models/Room');const Message = require('../models/Message');const User = require('../models/User');const getUserRooms = async (req, res) => {  try {    const rooms = await Room.find({      'members.user': req.user._id,      $or: [        { isPrivate: false },         {           isPrivate: true,          $expr: { $gt: [{ $size: '$members' }, 2] }         }      ]    })    .populate('admin', 'username avatar')    .populate('members.user', 'username avatar status')    .populate('lastMessage')    .sort({ updatedAt: -1 });    res.json(rooms);  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const createRoom = async (req, res) => {  try {    const { name, description, isPrivate, memberIds } = req.body;    const currentUser = await User.findById(req.user._id);    const members = [{ user: req.user._id }];    if (memberIds && Array.isArray(memberIds) && memberIds.length > 0) {      for (const friendId of memberIds) {        if (currentUser.friends.includes(friendId)) {          if (!currentUser.blockedUsers.includes(friendId)) {            const friendUser = await User.findById(friendId);            if (friendUser && !friendUser.blockedUsers.includes(req.user._id)) {              members.push({ user: friendId });            }          }        }      }    }    const finalIsPrivate = isPrivate && members.length > 2 ? true : false;    const room = await Room.create({      name,      description,      isPrivate: finalIsPrivate,      admin: req.user._id,      members    });    room.unreadCounts = members.map(member => ({      user: member.user,      count: 0    }));    await room.save();    const populatedRoom = await Room.findById(room._id)      .populate('admin', 'username avatar')      .populate('members.user', 'username avatar status');    res.status(201).json(populatedRoom);  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const getRoomById = async (req, res) => {  try {    const room = await Room.findById(req.params.id)      .populate('admin', 'username avatar')      .populate('members.user', 'username avatar status');    if (!room) {      return res.status(404).json({ message: 'Room not found' });    }    const isMember = room.members.some(      member => member.user._id.toString() === req.user._id.toString()    );    if (!isMember) {      return res.status(403).json({ message: 'Not authorized to access this room' });    }    res.json(room);  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const joinRoom = async (req, res) => {  try {    const { roomId } = req.body;    const room = await Room.findById(roomId);    if (!room) {      return res.status(404).json({ message: 'Room not found' });    }    const isMember = room.members.some(      member => member.user.toString() === req.user._id.toString()    );    if (isMember) {      return res.status(400).json({ message: 'Already a member of this room' });    }    room.members.push({ user: req.user._id });    await room.save();    const populatedRoom = await Room.findById(room._id)      .populate('admin', 'username avatar')      .populate('members.user', 'username avatar status');    res.json(populatedRoom);  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const leaveRoom = async (req, res) => {  try {    const room = await Room.findById(req.params.id);    if (!room) {      return res.status(404).json({ message: 'Room not found' });    }    const memberIndex = room.members.findIndex(      member => member.user.toString() === req.user._id.toString()    );    if (memberIndex === -1) {      return res.status(400).json({ message: 'Not a member of this room' });    }    room.members.splice(memberIndex, 1);    await room.save();    res.json({ message: 'Left room successfully' });  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const getOrCreateDirectRoom = async (req, res) => {  try {    const { friendId } = req.params;    const currentUserId = req.user._id;    const currentUser = await User.findById(currentUserId);    const isFriend = currentUser.friends.includes(friendId);    const isBlocked = currentUser.blockedUsers.includes(friendId);    const friendUser = await User.findById(friendId);    const hasBlockedMe = friendUser?.blockedUsers?.includes(currentUserId);    if (!isFriend) {      return res.status(403).json({         message: 'You can only message users who have accepted your friend request',        isFriend: false      });    }    if (isBlocked || hasBlockedMe) {      return res.status(403).json({         message: 'Cannot message this user',        isBlocked: true      });    }    let room = await Room.findOne({      isPrivate: true,      'members.user': { $all: [currentUserId, friendId] },      $expr: { $eq: [{ $size: '$members' }, 2] }     })    .populate('members.user', 'username avatar status')    .populate('lastMessage');    if (!room) {      room = await Room.create({        name: `Direct Message`,         description: '',        isPrivate: true,        admin: currentUserId,        members: [          { user: currentUserId },          { user: friendId }        ],        unreadCounts: [          { user: currentUserId, count: 0 },          { user: friendId, count: 0 }        ]      });      room = await Room.findById(room._id)        .populate('members.user', 'username avatar status')        .populate('lastMessage');    }    res.json({ room, isFriend: true });  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const addMembers = async (req, res) => {  try {    const { roomId } = req.params;    const { memberIds } = req.body;    const room = await Room.findById(roomId);    if (!room) {      return res.status(404).json({ message: 'Room not found' });    }    if (room.admin.toString() !== req.user._id.toString()) {      return res.status(403).json({ message: 'Only admin can add members' });    }    if (!memberIds || !Array.isArray(memberIds) || memberIds.length === 0) {      return res.status(400).json({ message: 'Please provide member IDs' });    }    const currentUser = await User.findById(req.user._id);    const addedMembers = [];    for (const memberId of memberIds) {      const isMember = room.members.some(        m => m.user.toString() === memberId      );      if (isMember) continue;      if (currentUser.friends.includes(memberId)) {        if (!currentUser.blockedUsers.includes(memberId)) {          const friendUser = await User.findById(memberId);          if (friendUser && !friendUser.blockedUsers.includes(req.user._id)) {            room.members.push({ user: memberId });            room.unreadCounts.push({              user: memberId,              count: 0            });            addedMembers.push(memberId);          }        }      }    }    await room.save();    const populatedRoom = await Room.findById(room._id)      .populate('admin', 'username avatar')      .populate('members.user', 'username avatar status');    res.json({       message: `${addedMembers.length} member(s) added successfully`,      room: populatedRoom    });  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};const removeMember = async (req, res) => {  try {    const { roomId, userId } = req.params;    const room = await Room.findById(roomId);    if (!room) {      return res.status(404).json({ message: 'Room not found' });    }    const isAdmin = room.admin.toString() === req.user._id.toString();    const isRemovingSelf = userId === req.user._id.toString();    if (!isAdmin && !isRemovingSelf) {      return res.status(403).json({ message: 'Not authorized to remove this member' });    }    if (isAdmin && isRemovingSelf && room.members.length > 1) {      return res.status(400).json({ message: 'Admin cannot remove themselves. Transfer admin first or leave room.' });    }    const memberIndex = room.members.findIndex(      m => m.user.toString() === userId    );    if (memberIndex === -1) {      return res.status(404).json({ message: 'Member not found in room' });    }    room.members.splice(memberIndex, 1);    const unreadIndex = room.unreadCounts.findIndex(      uc => uc.user.toString() === userId    );    if (unreadIndex !== -1) {      room.unreadCounts.splice(unreadIndex, 1);    }    await room.save();    const populatedRoom = await Room.findById(room._id)      .populate('admin', 'username avatar')      .populate('members.user', 'username avatar status');    res.json({       message: 'Member removed successfully',      room: populatedRoom    });  } catch (error) {    console.error(error);    res.status(500).json({ message: 'Server error' });  }};module.exports = {  getUserRooms,  createRoom,  getRoomById,  joinRoom,  leaveRoom,  getOrCreateDirectRoom,  addMembers,  removeMember};